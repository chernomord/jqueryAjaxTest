function getDevices(e){var t=$.Deferred();return $.ajax(e).done(function(e){t.resolve(e)}).fail(t.reject),t.promise()}function findDeviceID(e){for(i=0;i<$devices.length;i++)if($devices[i].id==e)return i}function getDeviceProps(e){return $devices[e].properties}function replaceDeviceProps(e,t){var n=findDeviceID(t);$devices[n].properties=e}function renderEditorForm(e){function t(e){for(var t in e)return console.log(e[t]),$('<div class="input"><span class="label">'+t+'</span><input type="text" name="'+t+'" value="'+e[t]+'"></div>')}var n=$('<form name="properties" data-id="'+e+'" method="post" action=""></form>');console.log(n),$('form[name="properties"]').remove();var o=getDeviceProps(findDeviceID(e));$(".editor").append(n);$('[name="properties"]');for(var r in o)if(o.hasOwnProperty(r)){var i={};i[r]=o[r],i={property:o[r]},console.log(i),$('[name="properties"]').append(t({property:o[r]}))}}function load(){console.log("populating ..."),getDevices(devicesConf).done(function(e){$dropped=!1,$devices=e,$IdsCollection=SortIdsByTypes($devices);var t;t=getDeviceProps(findDeviceID(99)),console.log(t),$('input[name="name"]').val("wow");var n=$('form[name="properties"]').serializeObject();console.log(n),renderEditorForm(99),$(".table").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",tolerance:"fit",drop:function(e,t){t.helper.attr("data-group");if(!$(t.helper).hasClass("element--group"))return!1;$dropped=!0;var n=$(t.helper).clone(!1).removeClass("ui-draggable-dragging").removeClass("element--group").css("opacity","1");$(this).append(n.draggable({containment:"parent"}));var o=parseInt(t.helper.attr("data-id"));n.children(".element__del").attr("data-id",o),$('span.element__del[data-id="'+o+'"]').click(function(){var e=$(this).parent(),t=e.attr("data-group"),n=parseInt(e.attr("data-id"));$IdsCollection[t].push(n),console.log($IdsCollection[t]);var o=$('.element--group[data-group="'+t+'"]'),r=o.children(".element__counter");r.addClass("counter--active"),r.text($IdsCollection[t].length),e.animate({opacity:0,left:700,top:200},100,function(){r.removeClass("counter--active"),e.remove()})})}}),renderElements($devices,$IdsCollection)}),$.when().done(console.log("populating : done"))}function SortIdsByTypes(e){function n(e){var t={};return e.filter(function(e){return t.hasOwnProperty(e)?!1:t[e]=!0})}var o=e.map(function(e,t){return e.type}),r=e.map(function(e,t){return[e.type,e.id]}),a=n(o);for(IdsCollection={},t=0;t<a.length;t++)for(IdsCollection[a[t]]=[],i=0;i<r.length;i++)r[i][0]==a[t]&&IdsCollection[a[t]].push(r[i][1]);return console.log(IdsCollection),IdsCollection}function renderElements(e,t){for(var n in t)if(t.hasOwnProperty(n)){var o=function(e,t){return e.type==n?!0:void 0},r=e.filter(o);$("div.elements__box").append('<div class="element--group" data-group="'+n+'"data-obj-count="'+t[n].length+'">'+n.replace(/_/g," ")+'<div class="element__counter">'+r.length+"</div></div>"),$('[data-group="'+n+'"]').draggable({opacity:.7,helper:"clone",revert:"invalid",start:function(e,t){var n=t.helper.attr("data-group");if($IdsCollection[n].length>0){var o=$IdsCollection[n].pop(),r=$IdsCollection[n].length;return $(this).children(".element__counter").text(r),t.helper.attr("data-id",o).children("div").css("display","none").parent().addClass("element--inst").append('<span class="element__del">x</span>')}return!1},stop:function(e,t){var n=t.helper.attr("data-group");if(0==$dropped){var o=t.helper.attr("data-id");return $IdsCollection[n].push(o),void $(this).children(".element__counter").text($IdsCollection[n].length)}return void($dropped=!1)}})}console.log(t)}var devicesConf={url:"devices.json",type:"GET",dataType:"json",success:function(e){return e},error:function(e,t,n){alert("Sorry, there was a problem!"),console.log("Error: "+n),console.log("Status: "+t)},complete:function(e,t){console.log("conf: devices.json loaded")}};$.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},$(document).ready(function(){load()}).bind().ajaxStart(function(){$("#loading").show()}).ajaxStop(function(){$("#loading").hide()});
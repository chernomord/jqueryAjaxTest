function getDevices(e){var t=$.Deferred();return $.ajax(e).done(function(e){t.resolve(e)}).fail(t.reject),t.promise()}function findDeviceID(e){for(var t=0;t<$devices.length;t++)if($devices[t].id==e)return t}function getDeviceProps(e){return $devices[e].properties}function replaceDeviceProps(e,t){var n=findDeviceID(t);$devices[n].properties=e}function renderEditorForm(e){function t(e){for(var t in e)return $('<div class="input"><span class="label">'+t+'</span><input type="text" name="'+t+'" value="'+e[t]+'"></div>')}var n=$('<form name="properties" data-id="'+e+'" method="post" action=""></form>'),r=getDeviceProps(findDeviceID(e));$('form[name="properties"]').remove();for(var a in r)if(r.hasOwnProperty(a)){var o={};o[a]=r[a],n.append(t(o).keyup(function(){var t=$('form[name="properties"]').serializeObject(),n=findDeviceID(e);$devices[n].properties=t}))}$(".editor").append(n)}function SortIdsByTypes(e){function t(e){var t={};return e.filter(function(e){return t.hasOwnProperty(e)?!1:t[e]=!0})}for(var n=e.map(function(e,t){return e.type}),r=e.map(function(e,t){return[e.type,e.id]}),a=t(n),o={},i=0;i<a.length;i++){o[a[i]]=[];for(var s=0;s<r.length;s++)r[s][0]==a[i]&&o[a[i]].push(r[s][1])}return o}function renderElements(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=function(e,t){return e.type==n?!0:void 0},a=e.filter(r);$("div.elements__box").append('<div class="element--group" data-group="'+n+'"data-obj-count="'+t[n].length+'">'+n.replace(/_/g," ")+'<div class="element__counter">'+a.length+"</div></div>"),$('[data-group="'+n+'"]').draggable({opacity:.7,zIndex:function(e,t){return $(this).zIndex()+10},helper:"clone",stack:"div.ui-draggable",revert:"invalid",start:function(e,t){var n=t.helper.attr("data-group");if($IdsCollection[n].length>0){1==$IdsCollection[n].length&&$(this).addClass("disabled");var r=$IdsCollection[n].pop(),a=$IdsCollection[n].length;return $(this).children(".element__counter").text(a),t.helper.attr("data-id",r).children("div").css("display","none").parent().addClass("element--inst").append('<span class="element__del">x</span>')}return!1},stop:function(e,t){var n=t.helper.attr("data-group");if(0==$dropped){$(this).removeClass("disabled");var r=t.helper.attr("data-id");$IdsCollection[n].push(r),$(this).children(".element__counter").text($IdsCollection[n].length)}else $dropped=!1}})}}function load(){console.log("populating ..."),getDevices(devicesConf).done(function(e){$dropped=!1,$devices=e,$IdsCollection=SortIdsByTypes($devices);var t;$(".table").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",tolerance:"fit",drop:function(e,n){n.helper.attr("data-group");if(!$(n.helper).hasClass("element--group"))return!1;$dropped=!0;var r=$(n.helper).clone(!1).removeClass("ui-draggable-dragging").removeClass("element--group").css("opacity","1").addClass("noclick").draggable({containment:"parent",stack:"div",revert:"invalid"}).click(function(){t&&t.removeClass("selected"),$(this).addClass("selected"),t=$(this),renderEditorForm(a)});$(this).append(r);var a=parseInt(n.helper.attr("data-id"));r.children(".element__del").attr("data-id",a),$('span.element__del[data-id="'+a+'"]').click(function(e){$(this).parent().attr("onclick","").unbind("click");var t=$(this).parent(),n=t.attr("data-group"),r=parseInt(t.attr("data-id")),a=$('.element--group[data-group="'+n+'"]'),o=a.children(".element__counter");$('form[name="properties"]').attr("data-id")==r&&$('form[name="properties"]').remove(),$IdsCollection[n].push(r),o.addClass("counter--active"),o.text($IdsCollection[n].length),a.removeClass("disabled");var i=a.offset().left,s=a.offset().top;t.zIndex(50),t.animate({opacity:.5,left:i,top:s},200,function(){o.removeClass("counter--active"),t.remove()})})}}),renderElements($devices,$IdsCollection)}),$.when().done(console.log("populating : done"))}var devicesConf={url:"devices.json",type:"GET",dataType:"json",success:function(e){return e},error:function(e,t,n){alert("Sorry, there was a problem!"),console.log("Error: "+n),console.log("Status: "+t)},complete:function(e,t){console.log("conf: devices.json loaded")}};$.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},$(document).ready(function(){load()}).bind().ajaxStart(function(){$("#loading").show()}).ajaxStop(function(){$("#loading").hide()});
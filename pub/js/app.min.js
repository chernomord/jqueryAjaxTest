function getDevices(e){var t=$.Deferred();return $.ajax(e).done(function(e){t.resolve(e)}).fail(t.reject),t.promise()}function load(){console.log("populating ...");var e=getDevices(devicesConf).done(function(e){$dropped=!1,$devices=e,$IdsCollection=SortIdsByTypes($devices),$(".table").droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",tolerance:"fit",drop:function(e,t){t.helper.attr("data-group");if(!$(t.helper).hasClass("element--group"))return!1;$dropped=!0;var n=$(t.helper).clone(!1).removeClass("ui-draggable-dragging").removeClass("element--group").css("opacity","1");$(this).append(n.draggable({containment:"parent"}));var o=parseInt(t.helper.attr("data-id"));n.children(".element__del").attr("data-id",o),$('span.element__del[data-id="'+o+'"]').click(function(){var e=$(this).parent(),t=e.attr("data-group"),n=parseInt(e.attr("data-id"));console.log(n),console.log($IdsCollection[t]),$IdsCollection[t].push(n),console.log($IdsCollection[t]);var o=$('[data-group="'+t+'"]');o.children(".element__counter").text($IdsCollection[t].length),e.animate({opacity:0,left:700,top:200},100,function(){e.remove()})})}}),renderElements($devices,$IdsCollection)});$.when(e).done(console.log("populating : done"))}function SortIdsByTypes(e){function n(e){var t={};return e.filter(function(e){return t.hasOwnProperty(e)?!1:t[e]=!0})}var o=e.map(function(e,t){return e.type}),r=e.map(function(e,t){return[e.type,e.id]}),l=n(o);for(IdsCollection={},t=0;t<l.length;t++)for(IdsCollection[l[t]]=[],i=0;i<r.length;i++)r[i][0]==l[t]&&IdsCollection[l[t]].push(r[i][1]);return console.log(IdsCollection),IdsCollection}function renderElements(e,t){for(var n in t)if(t.hasOwnProperty(n)){var o=function(e,t){return e.type==n?!0:void 0},r=e.filter(o);$("div.elements__box").append('<div class="element--group" data-group="'+n+'"data-obj-count="'+t[n].length+'">'+n.replace(/_/g," ")+'<div class="element__counter">'+r.length+"</div></div>"),$('[data-group="'+n+'"]').draggable({opacity:.7,helper:"clone",revert:"invalid",start:function(e,t){var n=t.helper.attr("data-group");if($IdsCollection[n].length>0){var o=$IdsCollection[n].pop(),r=$IdsCollection[n].length;return $(this).children(".element__counter").text(r),t.helper.attr("data-id",o).children("div").css("display","none").parent().addClass("element--inst").append('<span class="element__del">x</span>')}return!1},stop:function(e,t){var n=t.helper.attr("data-group");if(0==$dropped){var o=t.helper.attr("data-id");return $IdsCollection[n].push(o),void $(this).children(".element__counter").text($IdsCollection[n].length)}return void($dropped=!1)}})}console.log(t)}var devicesConf={url:"devices.json",type:"GET",dataType:"json",success:function(e){return e},error:function(e,t,n){alert("Sorry, there was a problem!"),console.log("Error: "+n),console.log("Status: "+t)},complete:function(e,t){console.log("conf: devices.json loaded")}};$(document).ready(function(){load()}).bind().ajaxStart(function(){$("#loading").show()}).ajaxStop(function(){$("#loading").hide()});